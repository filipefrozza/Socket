<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
    <canvas id="game" height="600" width="600" style="border: 1px solid black; float: right; width: 600px; height: 600px; cursor: none;"></canvas>
    <p id="click">Click Inativo</p>
    <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script type="text/javascript" src="http://filipefrozza/nodejs/view/game2/keydown.js"></script>
    <script type="text/javascript">
      var socket = io();
      USUARIO = null;
      MOUSE = {
        HOVER: {X:0,Y:0},
        CLICK: {}
      };

      POS = {
        X: 0,
        Y: 0
      };

      DIRECAO = 'baixo';
      CONECTADO = false;
      PLAYERS = [];
      CLICK = false;
      // PATH = [];

      $(document).ready(function(){
        CANVAS = document.getElementById('game');
        CTX = CANVAS.getContext('2d');
        var r = ~~(Math.random()*10000);
        // CANVAS.addEventListener('mousedown',function(evt){
        //   if(evt.button == 0){
        //     CLICK = true;
        //     $('#click').html('Click Ativo');
        //   }
        // });

        setarKeyDown();

        socket.emit('conectar',JSON.stringify({USER: r}));
        socket.on('conectado',function(m){
          PLAYERS[m.USER] = m.P;
          console.log(m.USER+" se conectou");
        });
        socket.on('conectado_'+r,function(m){
          console.log(m);
          CONECTADO = true;
          USUARIO = r;
          // PATH[USUARIO] = [];
          var loadPlayers = JSON.parse(m);
          for(P in loadPlayers){
            PLAYERS[P] = loadPlayers[P];
          }
          
          DRAW();
        });
        socket.on('atualizar_cliente',function(m){
          m = JSON.parse(m);
          console.log(m);
          PLAYERS[m.USER][m.KEY] = m.VALUE;
        });
        socket.on('disconnection',function(m){
          console.log(m+" se desconectou");
          delete PLAYERS[m];
        });
        DRAW = function(){
          CTX.clearRect(0,0,CANVAS.width,CANVAS.height);
          // console.log(PLAYERS);
          // CTX.fillRect(POS.X, POS.Y, 4, 4);
          for(P in PLAYERS){
            // if(P != USUARIO) {
              CTX.fillRect(PLAYERS[P].POS.X,PLAYERS[P].POS.Y,4,4);
            // }
          }
          requestAnimationFrame(DRAW);
        }
      });

      window.onbeforeunload = confirmExit;
      function confirmExit() {
        console.log('saindo');
        socket.emit('disconnected',USUARIO);
      }
    </script>
  </body>
</html>
